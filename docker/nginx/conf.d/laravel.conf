# ==============================================================================
# Laravel Virtual Host Configuration
# ==============================================================================
# Purpose: Serve Laravel application with optimal routing and security
# ==============================================================================

server {
    listen 80;
    listen [::]:80;
    
    server_name localhost;
    root /var/www/public;
    index index.php index.html;

    # Character set
    charset utf-8;

    # -------------------------------------------------------------------------
    # Logging
    # -------------------------------------------------------------------------
    access_log /var/log/nginx/laravel-access.log main;
    error_log /var/log/nginx/laravel-error.log warn;

    # -------------------------------------------------------------------------
    # Security
    # -------------------------------------------------------------------------
    
    # Disable directory listing
    autoindex off;
    
    # Connection limit (10 concurrent per IP)
    limit_conn conn_limit 10;
    
    # Global rate limit
    limit_req zone=global_limit burst=20 nodelay;

    # -------------------------------------------------------------------------
    # Health Check Endpoint (no auth, fast response)
    # -------------------------------------------------------------------------
    location = /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # -------------------------------------------------------------------------
    # Metrics Endpoint (should be protected in production)
    # -------------------------------------------------------------------------
    location = /metrics {
        access_log off;
        try_files $uri /index.php?$query_string;
    }

    # -------------------------------------------------------------------------
    # API Routes (stricter rate limiting)
    # -------------------------------------------------------------------------
    location /api {
        limit_req zone=api_limit burst=10 nodelay;
        try_files $uri /index.php?$query_string;
    }

    # -------------------------------------------------------------------------
    # Webhook Routes (dedicated rate limiting)
    # -------------------------------------------------------------------------
    location /webhooks {
        limit_req zone=webhook_limit burst=5 nodelay;
        
        # Only allow POST requests
        limit_except POST {
            deny all;
        }
        
        try_files $uri /index.php?$query_string;
    }

    # -------------------------------------------------------------------------
    # Static Assets (long cache)
    # -------------------------------------------------------------------------
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        
        # Fallback to Laravel if asset not found (for mix/vite manifests)
        try_files $uri /index.php?$query_string;
    }

    # -------------------------------------------------------------------------
    # Deny Access to Hidden Files
    # -------------------------------------------------------------------------
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # -------------------------------------------------------------------------
    # Deny Access to Sensitive Files
    # -------------------------------------------------------------------------
    location ~ /(composer\.json|composer\.lock|package\.json|package-lock\.json|yarn\.lock|\.env.*|phpunit\.xml|\.git)$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # -------------------------------------------------------------------------
    # Laravel Application Routing
    # -------------------------------------------------------------------------
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # -------------------------------------------------------------------------
    # PHP Processing via FastCGI
    # -------------------------------------------------------------------------
    location ~ \.php$ {
        # Security: prevent executing files like test.php.txt
        try_files $uri =404;
        
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        
        # Use Unix socket (better performance than TCP)
        fastcgi_pass unix:/var/run/php/php-fpm.sock;
        
        fastcgi_index index.php;
        
        # FastCGI parameters
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        
        # Timeouts
        fastcgi_connect_timeout 60s;
        fastcgi_send_timeout 180s;
        fastcgi_read_timeout 180s;
        
        # Buffering (tune based on your response sizes)
        fastcgi_buffer_size 128k;
        fastcgi_buffers 256 16k;
        fastcgi_busy_buffers_size 256k;
        fastcgi_temp_file_write_size 256k;
        
        # Keep connections alive
        fastcgi_keep_conn on;
        
        # Hide PHP version
        fastcgi_hide_header X-Powered-By;
    }

    # -------------------------------------------------------------------------
    # Custom Error Pages
    # -------------------------------------------------------------------------
    error_page 404 /index.php;
    error_page 500 502 503 504 /50x.html;
    
    location = /50x.html {
        root /usr/share/nginx/html;
        internal;
    }
}