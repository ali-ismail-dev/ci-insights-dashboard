; ==============================================================================
; OPcache Configuration for Production Performance
; ==============================================================================
; Purpose: Maximize PHP performance through bytecode caching
; Free-tier optimized: Conservative memory settings
; ==============================================================================

[opcache]

; -------------------------------------------------------------------------
; Enable OPcache
; -------------------------------------------------------------------------
opcache.enable = 0
opcache.enable_cli = 1

; -------------------------------------------------------------------------
; Memory Configuration (free-tier: 128MB, production: 256MB+)
; -------------------------------------------------------------------------

; OPcache memory consumption (MB)
opcache.memory_consumption = 128

; Interned strings buffer (MB) - for storing class/function names
opcache.interned_strings_buffer = 16

; Maximum number of files to cache
; Laravel app typically has 2000-5000 files
opcache.max_accelerated_files = 10000

; -------------------------------------------------------------------------
; File Validation & Revalidation
; -------------------------------------------------------------------------

; How often to check file timestamps (seconds)
; Development: 0 (always check)
; Production: 60 (check every minute) or 0 with manual cache clearing
opcache.revalidate_freq = 60

; Validate cached file permissions
opcache.validate_permission = 1

; Validate cached file ownership
opcache.validate_root = 1

; Enable file timestamp validation
opcache.validate_timestamps = 1

; -------------------------------------------------------------------------
; Performance Optimizations
; -------------------------------------------------------------------------

; Enable fast shutdown (faster PHP process termination)
opcache.fast_shutdown = 1

; Save compiled files between restarts (requires writable opcache.file_cache)
opcache.file_cache = /tmp/opcache

; Use file cache even when OPcache is full
opcache.file_cache_only = 0

; Enable file cache fallback
opcache.file_cache_fallback = 1

; Validate file cache checksums
opcache.file_cache_consistency_checks = 1

; -------------------------------------------------------------------------
; Error Handling
; -------------------------------------------------------------------------

; Log OPcache errors
opcache.error_log = /var/log/php/opcache-error.log

; -------------------------------------------------------------------------
; Advanced Settings
; -------------------------------------------------------------------------

; Maximum memory wasted before restart (percentage)
opcache.max_wasted_percentage = 5

; Enable opcode consistency checks (development only)
opcache.consistency_checks = 0

; Protect shared memory from unintended modifications
opcache.protect_memory = 1

; Enable copying of PHP code into HUGE PAGES (Linux optimization)
opcache.huge_code_pages = 0

; Optimization level (0-1, disabled in some PHP versions)
opcache.optimization_level = 0x7FFFFFFF

; -------------------------------------------------------------------------
; JIT Configuration (PHP 8.2+)
; -------------------------------------------------------------------------

; JIT buffer size (0 = disabled, recommended: 100M for production)
; Free-tier: Start with 50M and monitor
opcache.jit_buffer_size = 0

; JIT compilation strategy
; 1255 = recommended for Laravel (CRTO - tracing with type inference)
opcache.jit = 0

; -------------------------------------------------------------------------
; Blacklist (files to exclude from caching)
; -------------------------------------------------------------------------

; Path to blacklist file (optional)
; opcache.blacklist_filename = /etc/php/opcache-blacklist.txt

; -------------------------------------------------------------------------
; Preloading (PHP 7.4+)
; -------------------------------------------------------------------------

; Preload Laravel application files for maximum performance
; Requires opcache.preload script to be configured
; Enable in production after warming up cache
; opcache.preload = /var/www/preload.php
; opcache.preload_user = www-data